<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LM DIGITAL | Flow Builder Enterprise Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* LM Digital Official Branding Colors */
            --lm-blue: #0052CC;
            --lm-blue-dark: #0747A6;
            --lm-blue-light: #DEEBFF;
            --lm-blue-50: #EFF6FF;
            --lm-blue-100: #DBEAFE;
            
            --lm-green: #36B37E;
            --lm-orange: #FF991F;
            --lm-purple: #6554C0;
            --lm-red: #FF5630;
            --lm-gray: #6B778C;
            
            --bg-app: #F8FAFC;
            --bg-panel: #FFFFFF;
            --bg-hover: #F1F5F9;
            --border-color: #E2E8F0;
            --border-focus: #CBD5E1;
            --text-primary: #1E293B;
            --text-secondary: #64748B;
            --text-muted: #94A3B8;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

            --node-width: 280px;
            --grid-size: 20px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            box-sizing: border-box; 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
            outline: none; 
        }
        
        body { 
            margin: 0; 
            height: 100vh; 
            background: linear-gradient(135deg, var(--bg-app) 0%, #E2E8F0 100%); 
            display: flex; 
            flex-direction: column; 
            color: var(--text-primary);
            overflow: hidden;
            font-size: 14px;
        }

        /* --- Header Enterprise --- */
        header { 
            height: 70px; 
            background: var(--bg-panel); 
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 32px; 
            z-index: 100;
            position: sticky;
            top: 0;
        }

        .brand { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-weight: 700; 
            font-size: 20px; 
            color: var(--lm-blue-dark); 
            letter-spacing: -0.02em;
        }
        .brand-logo {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--lm-blue), var(--lm-blue-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            font-weight: 700;
        }
        .brand span { 
            padding: 6px 12px; 
            background: var(--lm-blue-light); 
            color: var(--lm-blue); 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .header-actions { display: flex; gap: 12px; align-items: center; }
        
        .btn { 
            padding: 10px 20px; 
            border-radius: 8px; 
            border: 1px solid transparent; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px; 
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before { left: 100%; }
        
        .btn-primary { 
            background: linear-gradient(135deg, var(--lm-blue), var(--lm-blue-dark)); 
            color: white; 
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary { 
            background: white; 
            border-color: var(--border-color); 
            color: var(--text-primary); 
        }
        .btn-secondary:hover { 
            background: var(--bg-hover); 
            border-color: var(--lm-blue-light);
        }

        .btn-danger { 
            background: #FEF2F2; 
            color: var(--lm-red); 
            border-color: #FECACA;
            font-weight: 600;
        }
        .btn-danger:hover { 
            background: #FECACA; 
            transform: translateY(-1px);
        }

        /* Status Indicator */
        .status-indicator {
            width: 10px;
            height: 10px;
            background: #10B981;
            border-radius: 50%;
            box-shadow: 0 0 0 2px white;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* --- Layout Principal --- */
        .app-container { 
            flex: 1; 
            display: flex; 
            overflow: hidden; 
            position: relative; 
        }

        /* --- Sidebar Profissional --- */
        .sidebar { 
            width: 340px; 
            background: var(--bg-panel); 
            border-right: 1px solid var(--border-color); 
            display: flex; 
            flex-direction: column; 
            z-index: 10;
            box-shadow: var(--shadow-md);
        }
        
        .sidebar-header {
            padding: 24px 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        .sidebar-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }
        .sidebar-subtitle {
            color: var(--text-secondary);
            font-size: 13px;
            margin: 0;
        }
        
        .sidebar-content { 
            padding: 0 20px 20px; 
            overflow-y: auto; 
            flex: 1;
        }
        
        .section-title { 
            font-size: 11px; 
            font-weight: 700; 
            text-transform: uppercase; 
            color: var(--lm-blue); 
            margin: 32px 0 16px 0; 
            letter-spacing: 0.8px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--lm-blue-light);
        }
        .section-title:first-child { margin-top: 0; }

        .node-template { 
            padding: 16px 20px; 
            background: white; 
            border: 2px solid transparent;
            border-radius: 12px; 
            margin-bottom: 12px; 
            cursor: grab; 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            transition: var(--transition);
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        .node-template::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--lm-blue);
            opacity: 0;
            transition: var(--transition);
        }
        .node-template:hover { 
            border-color: var(--lm-blue-light); 
            box-shadow: var(--shadow-lg); 
            transform: translateX(8px);
        }
        .node-template:hover::before { opacity: 1; }
        .node-template:active { cursor: grabbing; transform: scale(0.98); }

        .icon-box { 
            width: 40px; height: 40px; 
            border-radius: 10px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 18px; 
            color: white;
            flex-shrink: 0;
            box-shadow: var(--shadow-md);
            font-weight: 700;
        }

        /* --- Canvas Enterprise --- */
        .viewport { 
            flex: 1; 
            position: relative; 
            overflow: hidden; 
            background: 
                radial-gradient(circle at 1px 1px, #CBD5E1 1px, transparent 0);
            background-size: var(--grid-size) var(--grid-size);
            cursor: grab;
            transition: var(--transition);
        }
        .viewport:active { cursor: grabbing; }

        .canvas-layer { 
            width: 8000px; height: 8000px; 
            position: absolute; 
            top: -2000px; left: -2000px;
            transform-origin: 0 0;
        }

        svg { 
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0; 
            pointer-events: none; 
            overflow: visible; 
        }
        path { 
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        /* --- Nodes Enterprise Grade --- */
        .flow-node { 
            position: absolute; 
            width: var(--node-width); 
            background: white; 
            border-radius: 16px; 
            box-shadow: var(--shadow-lg);
            z-index: 5; 
            border: 3px solid transparent;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        .flow-node:hover { 
            box-shadow: var(--shadow-xl);
            transform: translateY(-4px);
        }
        .flow-node.selected { 
            border-color: var(--lm-blue); 
            box-shadow: 0 0 0 4px rgba(0, 82, 204, 0.15), var(--shadow-xl);
        }

        .node-header { 
            padding: 20px 24px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            font-weight: 700; 
            font-size: 15px; 
            color: var(--text-primary);
            border-radius: 12px 12px 0 0;
            background: linear-gradient(135deg, #F8FAFC, white);
            position: relative;
            overflow: hidden;
        }
        
        .node-header::before {
            content: ''; 
            width: 12px; 
            height: 12px; 
            border-radius: 50%;
            background: var(--node-color, var(--text-secondary));
            box-shadow: 0 0 0 2px white;
            flex-shrink: 0;
        }

        .node-body { 
            padding: 24px; 
            font-size: 14px; 
            color: var(--text-secondary); 
            line-height: 1.6; 
            min-height: 80px;
        }

        /* Ports Profissionais */
        .port { 
            width: 16px; height: 16px; 
            background: white; 
            border: 3px solid var(--text-secondary); 
            border-radius: 50%; 
            position: absolute; 
            top: 50%; 
            margin-top: -9px;
            z-index: 10; 
            cursor: crosshair; 
            transition: var(--transition);
            box-shadow: var(--shadow-md);
        }
        .port:hover { 
            background: var(--lm-blue); 
            border-color: var(--lm-blue-light); 
            transform: scale(1.4);
            box-shadow: 0 0 0 4px rgba(0, 82, 204, 0.2);
        }
        .port.input { left: -9px; }
        .port.output { right: -9px; }

        /* --- Editor Panel Enterprise --- */
        .editor-panel {
            width: 420px;
            background: white;
            border-left: 1px solid var(--border-color);
            position: absolute;
            right: -420px; 
            top: 70px; 
            bottom: 0;
            transition: right 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            z-index: 50;
            display: flex; 
            flex-direction: column;
            box-shadow: -8px 0 40px rgba(0,0,0,0.1);
        }
        .editor-panel.open { right: 0; }

        .editor-header {
            padding: 28px 28px 0;
            border-bottom: 1px solid var(--border-color);
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 28px;
        }
        .editor-title { 
            font-weight: 800; 
            font-size: 20px; 
            color: var(--lm-blue-dark);
        }
        .editor-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .editor-content { 
            padding: 0 28px 28px; 
            flex: 1; 
            overflow-y: auto; 
        }
        
        .editor-footer {
            padding: 28px;
            border-top: 1px solid var(--border-color);
            display: flex; 
            gap: 12px;
            background: #F8FAFC;
            border-radius: 0 0 16px 16px;
        }

        .form-group { 
            margin-bottom: 28px; 
        }
        .form-label { 
            display: block; 
            font-size: 12px; 
            font-weight: 700; 
            margin-bottom: 8px; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            letter-spacing: 0.5px;
        }
        .form-input, 
        .form-textarea, 
        .form-select { 
            width: 100%; 
            padding: 14px 16px; 
            border: 2px solid var(--border-color); 
            border-radius: 10px; 
            font-size: 15px; 
            transition: var(--transition);
            background: white;
            font-family: inherit;
        }
        .form-input:focus, 
        .form-textarea:focus, 
        .form-select:focus { 
            border-color: var(--lm-blue); 
            box-shadow: 0 0 0 4px var(--lm-blue-50); 
            transform: translateY(-1px);
        }

        .form-row {
            display: flex;
            gap: 12px;
        }
        .form-row .form-input {
            flex: 1;
        }

        /* Menu Type Selector */
        .menu-type-selector {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .menu-type-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 13px;
            font-weight: 500;
        }
        .menu-type-option.active {
            border-color: var(--lm-blue);
            background: var(--lm-blue-50);
            color: var(--lm-blue);
        }

        /* Loading Animation */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--lm-blue);
            font-size: 13px;
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--lm-blue-light);
            border-top: 2px solid var(--lm-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .sidebar { width: 300px; }
            .editor-panel { width: 380px; }
        }
    </style>
</head>
<body>

<header>
    <div class="brand">
        <div class="brand-logo">LM</div>
        <div>
            <div>LM DIGITAL</div>
            <span>Flow Builder Enterprise Pro</span>
        </div>
    </div>
    <div class="header-actions">
        <div style="display: flex; align-items: center; gap: 12px; color: var(--text-secondary); font-size: 13px;">
            <div class="status-indicator"></div>
            <span>Online</span>
        </div>
        <button class="btn btn-secondary" onclick="builder.clearCanvas()" title="Limpar Canvas">
            üóëÔ∏è Limpar Tudo
        </button>
        <button class="btn btn-primary" onclick="builder.exportFlow()" title="Exportar Fluxo">
            üíæ Exportar JSON
        </button>
        <button class="btn btn-primary" onclick="builder.saveFlow()" title="Salvar no Cloud">
            ‚òÅÔ∏è Salvar Cloud
        </button>
    </div>
</header>

<div class="app-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Blocos Dispon√≠veis</h3>
            <p class="sidebar-subtitle">Arraste para criar seu fluxo</p>
        </div>
        
        <div class="sidebar-content">
            <!-- üß† IA / Agentes -->
            <div class="section-title">üß† IA / Agentes</div>
            <div class="node-template" draggable="true" data-type="supervisor-ai" data-color="#8B5CF6">
                <div class="icon-box" style="background: #8B5CF6">üß†</div>
                <div>Supervisor IA</div>
            </div>
            <div class="node-template" draggable="true" data-type="agent-ai" data-color="#EC4899">
                <div class="icon-box" style="background: #EC4899">ü§ñ</div>
                <div>Agente IA</div>
            </div>

            <!-- üí¨ Mensagens -->
            <div class="section-title">üí¨ Mensagens</div>
            <div class="node-template" draggable="true" data-type="text-message" data-color="var(--lm-blue)">
                <div class="icon-box" style="background: var(--lm-blue)">üìù</div>
                <div>Enviar Texto</div>
            </div>
            <div class="node-template" draggable="true" data-type="menu" data-color="var(--lm-green)">
                <div class="icon-box" style="background: var(--lm-green)">‚ò∞</div>
                <div>Enviar Menu</div>
            </div>
            <div class="node-template" draggable="true" data-type="template" data-color="#F59E0B">
                <div class="icon-box" style="background: #F59E0B">üìÑ</div>
                <div>Enviar Template</div>
            </div>
            <div class="node-template" draggable="true" data-type="question" data-color="#10B981">
                <div class="icon-box" style="background: #10B981">‚ùì</div>
                <div>Pergunta</div>
            </div>

            <!-- üë§ Contato -->
            <div class="section-title">üë§ Contato</div>
            <div class="node-template" draggable="true" data-type="sequence" data-color="#3B82F6">
                <div class="icon-box" style="background: #3B82F6">üìä</div>
                <div>Sequ√™ncia</div>
            </div>
            <div class="node-template" draggable="true" data-type="tags" data-color="#8B5CF6">
                <div class="icon-box" style="background: #8B5CF6">üè∑Ô∏è</div>
                <div>Etiquetas</div>
            </div>

            <!-- üéß Atendimento -->
            <div class="section-title">üéß Atendimento</div>
            <div class="node-template" draggable="true" data-type="transfer" data-color="#EF4444">
                <div class="icon-box" style="background: #EF4444">üë§</div>
                <div>Transferir</div>
            </div>
            <div class="node-template" draggable="true" data-type="end" data-color="var(--lm-red)">
                <div class="icon-box" style="background: var(--lm-red)">‚úÖ</div>
                <div>Encerrar</div>
            </div>

            <!-- üöÄ CRM -->
            <div class="section-title">üöÄ CRM</div>
            <div class="node-template" draggable="true" data-type="create-card" data-color="var(--lm-green)">
                <div class="icon-box" style="background: var(--lm-green)">‚ûï</div>
                <div>Criar Card</div>
            </div>
            <div class="node-template" draggable="true" data-type="move-card" data-color="#10B981">
                <div class="icon-box" style="background: #10B981">üîÑ</div>
                <div>Mover Card</div>
            </div>

            <!-- ‚öôÔ∏è Controle & L√≥gica -->
            <div class="section-title">‚öôÔ∏è Controle & L√≥gica</div>
            <div class="node-template" draggable="true" data-type="condition" data-color="var(--lm-orange)">
                <div class="icon-box" style="background: var(--lm-orange)">‚öñÔ∏è</div>
                <div>Condicional</div>
            </div>
            <div class="node-template" draggable="true" data-type="wait" data-color="var(--lm-purple)">
                <div class="icon-box" style="background: var(--lm-purple)">‚è≥</div>
                <div>Aguardar</div>
            </div>
            <div class="node-template" draggable="true" data-type="webhook" data-color="#6366F1">
                <div class="icon-box" style="background: #6366F1">üåê</div>
                <div>Webhook</div>
            </div>
        </div>
    </aside>

    <main class="viewport" id="viewport">
        <div class="canvas-layer" id="canvas">
            <svg id="svg-connections"></svg>
        </div>
    </main>

    <aside class="editor-panel" id="editor">
        <div class="editor-header">
            <div>
                <div class="editor-title" id="editor-title">Configurar Bloco</div>
                <div class="editor-subtitle" id="editor-subtitle">Personalize sua a√ß√£o</div>
            </div>
            <button class="btn" style="padding: 8px 12px; font-size: 16px;" onclick="builder.closeEditor()">‚úï</button>
        </div>
        <div class="editor-content" id="editor-body"></div>
        <div class="editor-footer">
            <button class="btn btn-secondary" onclick="builder.discardChanges()">Cancelar</button>
            <button class="btn btn-primary" style="flex:1" onclick="builder.applyChanges()">
                <span id="apply-text">Salvar Altera√ß√µes</span>
                <div id="apply-loading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    Salvando...
                </div>
            </button>
        </div>
    </aside>
</div>

<script>
/**
 * LM Digital Flow Builder Enterprise Pro v2.0
 * Plataforma SAAS Profissional - N√≠vel Enterprise
 */
class FlowBuilder {
    constructor() {
        this.nodes = [];
        this.connections = [];
        this.currentId = 0;
        
        // States avan√ßados
        this.isDraggingNode = false;
        this.dragOffset = { x: 0, y: 0 };
        this.draggedNode = null;
        
        this.isConnecting = false;
        this.connectionSource = null;
        this.tempPath = null;

        // Editor State Enterprise
        this.selectedNode = null;
        this.tempNodeState = null;
        this.isSaving = false;

        // Undo/Redo Stack (Enterprise Feature)
        this.undoStack = [];
        this.redoStack = [];

        // DOM Cache
        this.canvas = document.getElementById('canvas');
        this.svg = document.getElementById('svg-connections');
        this.editor = document.getElementById('editor');
        this.viewport = document.getElementById('viewport');

        this.init();
    }

    init() {
        this.bindSidebarEvents();
        this.bindCanvasEvents();
        this.bindKeyboardShortcuts();
        this.loadFromStorage();
        this.captureState(); // Initial state for undo
    }

    // --- Drag & Drop Enterprise ---
    bindSidebarEvents() {
        document.querySelectorAll('.node-template').forEach(el => {
            el.addEventListener('dragstart', (e) => {
                const type = el.dataset.type;
                const color = el.dataset.color;
                const label = el.querySelector('div:last-child').innerText;
                const icon = el.querySelector('.icon-box').innerText;
                
                const payload = JSON.stringify({ 
                    type, 
                    color, 
                    label, 
                    icon,
                    config: this.getDefaultConfig(type)
                });
                
                e.dataTransfer.setData('application/json', payload);
                e.dataTransfer.effectAllowed = 'copy';
            });
        });
    }

    getDefaultConfig(type) {
        const defaults = {
            'supervisor-ai': { model: 'gpt-4o', instructions: 'Analise e roteie adequadamente' },
            'agent-ai': { agent: 'vendas', instructions: 'Atenda como especialista' },
            'text-message': { message: 'Digite sua mensagem aqui...', delay: 0 },
            'menu': { 
                type: 'buttons', 
                options: ['Op√ß√£o 1', 'Op√ß√£o 2', 'Op√ß√£o 3'],
                message: 'Escolha uma op√ß√£o:'
            },
            'template': { name: 'welcome_template', params: {} },
            'question': { question: 'Como posso ajudar?', variable: 'resposta_usuario' },
            'sequence': { campaign: 'default', schedule: 'immediate' },
            'tags': { tags: ['novo', 'lead'], action: 'add' },
            'transfer': { department: 'vendas', message: 'Transferindo...' },
            'end': { message: 'Obrigado pelo contato!' },
            'create-card': { title: 'Novo Lead', board: 'vendas' },
            'move-card': { from: 'novo', to: 'em_negociacao' },
            'condition': { condition: 'equals', variable: 'tag', value: '' },
            'wait': { duration: 5, unit: 'seconds' },
            'webhook': { url: 'https://api.exemplo.com/webhook', method: 'POST' }
        };
        return defaults[type] || { description: 'Configurar...' };
    }

    // --- Canvas Events ---
    bindCanvasEvents() {
        this.viewport.addEventListener('dragover', e => { 
            e.preventDefault(); 
            e.dataTransfer.dropEffect = 'copy'; 
        });
        
        this.viewport.addEventListener('drop', e => {
            e.preventDefault();
            try {
                const data = JSON.parse(e.dataTransfer.getData('application/json'));
                const rect = this.canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                this.captureState();
                this.addNode(x, y, data);
            } catch(err) { 
                console.error('Drop inv√°lido:', err); 
            }
        });

        // Drag & Connection Logic
        document.addEventListener('mousemove', e => {
            if (this.isDraggingNode && this.draggedNode) {
                const rect = this.canvas.getBoundingClientRect();
                this.draggedNode.element.style.left = `${e.clientX - rect.left - this.dragOffset.x}px`;
                this.draggedNode.element.style.top = `${e.clientY - rect.top - this.dragOffset.y}px`;
                this.updateAllConnections();
            }
            if (this.isConnecting && this.tempPath) {
                this.updateTempConnection(e);
            }
        });

        document.addEventListener('mouseup', e => {
            this.isDraggingNode = false;
            this.draggedNode = null;
            
            if (this.isConnecting) {
                if (e.target.classList.contains('input')) {
                    this.finishConnection(e.target.closest('.flow-node'));
                } else {
                    if (this.tempPath) this.tempPath.remove();
                }
                this.isConnecting = false;
                this.tempPath = null;
            }
        });
    }

    // Keyboard Shortcuts Enterprise
    bindKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key) {
                case 'Delete':
                case 'Backspace':
                    if (this.selectedNode) {
                        this.captureState();
                        this.deleteSelected();
                    }
                    break;
                case 'Escape':
                    this.closeEditor();
                    break;
                case 's':
                case 'S':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        this.saveFlow();
                    }
                    break;
                case 'z':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        this.undo();
                    }
                    break;
                case 'y':
                    if (e.ctrlKey || e.metaKey) {
                        e.preventDefault();
                        this.redo();
                    }
                    break;
            }
        });
    }

    // --- Node Management ---
    addNode(x, y, data) {
        this.currentId++;
        const id = this.currentId;
        
        const el = document.createElement('div');
        el.className = 'flow-node';
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        el.dataset.id = id;
        el.style.setProperty('--node-color', data.color);

        el.innerHTML = `
            <div class="node-header">
                <span>${data.icon}</span> 
                <span class="n-title">${data.label}</span>
            </div>
            <div class="node-body">${data.config?.description || data.config?.message || 'Configurar par√¢metros...'}</div>
            <div class="port input"></div>
            <div class="port output"></div>
        `;

        this.canvas.appendChild(el);

        const nodeObj = {
            id: id,
            element: el,
            data: { ...data, config: data.config || { description: 'Configurar...' } }
        };
        this.nodes.push(nodeObj);

        this.setupNodeEvents(nodeObj);
    }

    setupNodeEvents(node) {
        const header = node.element.querySelector('.node-header');
        header.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            this.isDraggingNode = true;
            this.draggedNode = node;
            const r = node.element.getBoundingClientRect();
            this.dragOffset = { x: e.clientX - r.left, y: e.clientY - r.top };
            this.selectNode(node);
        });

        node.element.addEventListener('click', (e) => {
            e.stopPropagation();
            this.selectNode(node);
        });

        const outPort = node.element.querySelector('.output');
        outPort.addEventListener('mousedown', (e) => {
            e.stopPropagation();
            this.startConnection(e, node);
        });
        
        const inPort = node.element.querySelector('.input');
        inPort.addEventListener('mouseup', (e) => {
            e.stopPropagation();
            this.finishConnection(node);
        });
    }

    // --- Connection System ---
    startConnection(e, fromNode) {
        this.isConnecting = true;
        this.connectionSource = fromNode.element.querySelector('.output');
        
        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.setAttribute("stroke", "#CBD5E1");
        path.setAttribute("stroke-width", "3");
        path.setAttribute("fill", "none");
        path.setAttribute("stroke-dasharray", "8,8");
        this.svg.appendChild(path);
        this.tempPath = path;
    }

    finishConnection(toNode) {
        if (!this.isConnecting || !this.tempPath || !this.connectionSource) return;
        
        const fromId = parseInt(this.connectionSource.closest('.flow-node').dataset.id);
        const toId = toNode.id;

        if (fromId === toId) { 
            this.tempPath.remove(); 
            return; 
        }

        this.captureState();

        this.tempPath.setAttribute("stroke", "var(--lm-blue)");
        this.tempPath.setAttribute("stroke-width", "4");
        this.removeDash(this.tempPath);

        this.connections.push({
            path: this.tempPath,
            from: fromId,
            to: toId,
            sourceEl: this.connectionSource,
            targetEl: toNode.element.querySelector('.input')
        });

        this.updateAllConnections();
        this.isConnecting = false;
        this.tempPath = null;
        this.connectionSource = null;
    }

    updateTempConnection(e) {
        const canvasRect = this.canvas.getBoundingClientRect();
        const sourceRect = this.connectionSource.getBoundingClientRect();
        
        const startX = (sourceRect.left + sourceRect.width/2) - canvasRect.left;
        const startY = (sourceRect.top + sourceRect.height/2) - canvasRect.top;
        const endX = e.clientX - canvasRect.left;
        const endY = e.clientY - canvasRect.top;
        
        this.drawBezier(this.tempPath, startX, startY, endX, endY);
    }

    updateAllConnections() {
        const canvasRect = this.canvas.getBoundingClientRect();
        this.connections.forEach(conn => {
            const srcRect = conn.sourceEl.getBoundingClientRect();
            const tgtRect = conn.targetEl.getBoundingClientRect();

            const x1 = (srcRect.left + srcRect.width/2) - canvasRect.left;
            const y1 = (srcRect.top + srcRect.height/2) - canvasRect.top;
            const x2 = (tgtRect.left + tgtRect.width/2) - canvasRect.left;
            const y2 = (tgtRect.top + tgtRect.height/2) - canvasRect.top;

            this.drawBezier(conn.path, x1, y1, x2, y2);
        });
    }

    drawBezier(path, x1, y1, x2, y2) {
        const dx = x2 - x1;
        const dy = y2 - y1;
        const controlOffset = Math.max(Math.abs(dx) * 0.4, 60) * (dx > 0 ? 1 : -1);
        const d = `M ${x1} ${y1} C ${x1 + controlOffset} ${y1}, ${x2 - controlOffset} ${y2}, ${x2} ${y2}`;
        path.setAttribute("d", d);
    }

    removeDash(path) {
        path.removeAttribute("stroke-dasharray");
        path.style.strokeDashoffset = '0';
    }

    // --- Editor Enterprise ---
    selectNode(node) {
        if (this.selectedNode) {
            this.selectedNode.element.classList.remove('selected');
        }
        this.selectedNode = node;
        node.element.classList.add('selected');

        this.tempNodeState = JSON.parse(JSON.stringify(node));
        this.openEditor(node);
    }

    openEditor(node) {
        this.editor.classList.add('open');
        const body = document.getElementById('editor-body');
        const titleEl = document.getElementById('editor-title');
        const subtitleEl = document.getElementById('editor-subtitle');
        
        titleEl.textContent = `Configurar ${node.data.label}`;
        subtitleEl.textContent = `Bloco #${node.id} ‚Ä¢ ${node.data.type.replace(/-/g, ' ').toUpperCase()}`;

        body.innerHTML = this.generateEditorForm(node);
        
        // Bind live updates
        this.bindEditorEvents(node);
    }

    generateEditorForm(node) {
        const config = node.data.config;
        const type = node.data.type;

        const forms = {
            'supervisor-ai': `
                <div class="form-group">
                    <label class="form-label">Modelo IA</label>
                    <select class="form-select" id="model">
                        <option value="gpt-4o" ${config.model === 'gpt-4o' ? 'selected' : ''}>GPT-4o (Padr√£o)</option>
                        <option value="gpt-4-turbo">GPT-4 Turbo</option>
                        <option value="claude-3">Claude 3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Instru√ß√µes</label>
                    <textarea class="form-textarea" id="instructions" rows="6">${config.instructions}</textarea>
                </div>
            `,
            'agent-ai': `
                <div class="form-group">
                    <label class="form-label">Agente</label>
                    <select class="form-select" id="agent">
                        <option value="vendas">Vendas</option>
                        <option value="suporte">Suporte</option>
                        <option value="financeiro">Financeiro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Prompt Personalizado</label>
                    <textarea class="form-textarea" id="instructions" rows="4">${config.instructions}</textarea>
                </div>
            `,
            'text-message': `
                <div class="form-group">
                    <label class="form-label">Mensagem</label>
                    <textarea class="form-textarea" id="message" rows="6">${config.message}</textarea>
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Delay (s)</label>
                        <input class="form-input" type="number" id="delay" value="${config.delay || 0}" min="0">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Velocidade</label>
                        <select class="form-select" id="speed">
                            <option value="normal">Normal</option>
                            <option value="lento">Lento (Humanizado)</option>
                        </select>
                    </div>
                </div>
            `,
            'menu': `
                <div class="form-group">
                    <label class="form-label">Mensagem de Apresenta√ß√£o</label>
                    <textarea class="form-textarea" id="message" rows="3">${config.message}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Tipo de Menu</label>
                    <div class="menu-type-selector">
                        <div class="menu-type-option ${config.type === 'buttons' ? 'active' : ''}" data-type="buttons">Bot√µes</div>
                        <div class="menu-type-option ${config.type === 'numeric' ? 'active' : ''}" data-type="numeric">Num√©rico</div>
                        <div class="menu-type-option ${config.type === 'list' ? 'active' : ''}" data-type="list">Lista</div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Op√ß√µes (uma por linha)</label>
                    <textarea class="form-textarea" id="options" rows="6">${config.options?.join('\n')}</textarea>
                </div>
            `,
            'webhook': `
                <div class="form-group">
                    <label class="form-label">URL do Webhook</label>
                    <input class="form-input" id="url" value="${config.url}" placeholder="https://">
                </div>
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">M√©todo</label>
                        <select class="form-select" id="method">
                            <option value="POST" ${config.method === 'POST' ? 'selected' : ''}>POST</option>
                            <option value="GET">GET</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Timeout (s)</label>
                        <input class="form-input" type="number" id="timeout" value="${config.timeout || 30}" min="5">
                    </div>
                </div>
            `,
            'wait': `
                <div class="form-row">
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Dura√ß√£o</label>
                        <input class="form-input" type="number" id="duration" value="${config.duration}" min="0">
                    </div>
                    <div class="form-group" style="flex:1">
                        <label class="form-label">Unidade</label>
                        <select class="form-select" id="unit">
                            <option value="seconds" ${config.unit === 'seconds' ? 'selected' : ''}>Segundos</option>
                            <option value="minutes">Minutos</option>
                            <option value="hours">Horas</option>
                        </select>
                    </div>
                </div>
            `
        };

        const genericForm = `
            <div class="form-group">
                <label class="form-label">ID do Bloco</label>
                <input class="form-input" value="#${node.id}" disabled style="background:var(--bg-hover); color:var(--text-muted);">
            </div>
            <div class="form-group">
                <label class="form-label">Nome Personalizado</label>
                <input class="form-input" id="label" value="${node.data.label}">
            </div>
            ${forms[type] || `
                <div class="form-group">
                    <label class="form-label">Configura√ß√£o</label>
                    <textarea class="form-textarea" id="description" rows="6">${JSON.stringify(config, null, 2)}</textarea>
                </div>
            `}
            <div style="margin-top: 32px; padding-top:24px; border-top:1px solid var(--border-color);">
                <button class="btn btn-danger" style="width:100%; justify-content:center;" onclick="builder.deleteSelected()">
                    üóëÔ∏è Excluir Bloco
                </button>
            </div>
        `;

        return genericForm;
    }

    bindEditorEvents(node) {
        // Live binding para todos os inputs
        document.querySelectorAll('#editor-body input, #editor-body textarea, #editor-body select').forEach(input => {
            input.addEventListener('input', (e) => {
                const field = e.target.id;
                const value = e.target.value;
                
                if (field === 'label') {
                    node.data.label = value;
                    node.element.querySelector('.n-title').textContent = value;
                } else if (field === 'options') {
                    node.data.config.options = value.split('\n').map(o => o.trim()).filter(Boolean);
                } else {
                    node.data.config[field] = value;
                }
                
                // Preview no node body
                const preview = this.getNodePreview(node.data);
                node.element.querySelector('.node-body').textContent = preview;
            });
        });

        // Menu type selector
        document.querySelectorAll('.menu-type-option').forEach(option => {
            option.addEventListener('click', (e) => {
                document.querySelectorAll('.menu-type-option').forEach(opt => opt.classList.remove('active'));
                e.target.classList.add('active');
                node.data.config.type = e.target.dataset.type;
            });
        });
    }

    getNodePreview(data) {
        const config = data.config;
        switch(data.type) {
            case 'text-message': return config.message.substring(0, 60) + (config.message.length > 60 ? '...' : '');
            case 'menu': return `${config.message || 'Menu:'} (${config.options?.length || 0} op√ß√µes)`;
            case 'wait': return `Aguardar ${config.duration} ${config.unit}`;
            default: return config.description || config.message || 'Configurado';
        }
    }

    // --- State Management Enterprise ---
    captureState() {
        this.undoStack.push({
            nodes: this.nodes.map(n => ({
                id: n.id,
                x: parseInt(n.element.style.left),
                y: parseInt(n.element.style.top),
                data: JSON.parse(JSON.stringify(n.data))
            })),
            connections: this.connections.map(c => ({ from: c.from, to: c.to }))
        });

        // Limit stack size
        if (this.undoStack.length > 50) {
            this.undoStack.shift();
        }
        this.redoStack = []; // Clear redo on new action
    }

    undo() {
        if (this.undoStack.length < 2) return;
        
        this.redoStack.push(this.undoStack.pop());
        const previousState = this.undoStack[this.undoStack.length - 1];
        
        this.loadState(previousState);
    }

    redo() {
        if (this.redoStack.length === 0) return;
        
        const nextState = this.redoStack.pop();
        this.undoStack.push(nextState);
        this.loadState(nextState);
    }

    loadState(state) {
        this.clearCanvas(false);
        
        // Load nodes
        state.nodes.forEach(n => {
            this.addNode(n.x, n.y, n.data);
            const newNode = this.nodes[this.nodes.length - 1];
            newNode.id = n.id;
            newNode.element.dataset.id = n.id;
            newNode.element.style.left = `${n.x}px`;
            newNode.element.style.top = `${n.y}px`;
        });

        // Load connections
        setTimeout(() => {
            state.connections.forEach(c => {
                const fromNode = this.nodes.find(n => n.id === c.from);
                const toNode = this.nodes.find(n => n.id === c.to);
                if (fromNode && toNode) {
                    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                    path.setAttribute("stroke", "var(--lm-blue)");
                    path.setAttribute("stroke-width", "4");
                    path.setAttribute("fill", "none");
                    this.svg.appendChild(path);
                    
                    this.connections.push({
                        path, from: c.from, to: c.to, 
                        sourceEl: fromNode.element.querySelector('.output'),
                        targetEl: toNode.element.querySelector('.input')
                    });
                }
            });
            this.updateAllConnections();
        }, 100);
    }

    // --- Editor Actions ---
    closeEditor() {
        this.editor.classList.remove('open');
        if (this.selectedNode) {
            this.selectedNode.element.classList.remove('selected');
            this.selectedNode = null;
        }
    }

    applyChanges() {
        if (this.isSaving) return;
        
        this.isSaving = true;
        const applyBtn = document.querySelector('.editor-footer .btn-primary');
        const applyText = document.getElementById('apply-text');
        const applyLoading = document.getElementById('apply-loading');
        
        applyText.style.display = 'none';
        applyLoading.style.display = 'flex';
        
        // Simulate API save
        setTimeout(() => {
            this.captureState();
            this.closeEditor();
            this.isSaving = false;
            applyText.style.display = 'flex';
            applyLoading.style.display = 'none';
        }, 1200);
    }

    discardChanges() {
        if (!this.selectedNode || !this.tempNodeState) return;

        this.selectedNode.data = JSON.parse(JSON.stringify(this.tempNodeState));
        this.selectedNode.element.querySelector('.n-title').textContent = this.selectedNode.data.label;
        this.selectedNode.element.querySelector('.node-body').textContent = this.getNodePreview(this.selectedNode.data);
        
        this.tempNodeState = null;
        this.closeEditor();
    }

    deleteSelected() {
        if (!this.selectedNode) return;
        
        if (!confirm(`Excluir bloco #${this.selectedNode.id}?`)) return;
        
        const id = this.selectedNode.id;
        
        this.connections = this.connections.filter(c => {
            if (c.from === id || c.to === id) {
                c.path.remove();
                return false;
            }
            return true;
        });

        this.selectedNode.element.remove();
        this.nodes = this.nodes.filter(n => n.id !== id);
        
        this.closeEditor();
    }

    // --- Persist√™ncia Enterprise ---
    saveFlow() {
        const payload = {
            version: '2.0',
            name: 'Meu Fluxo LM Digital',
            nodes: this.nodes.map(n => ({
                id: n.id,
                x: parseInt(n.element.style.left),
                y: parseInt(n.element.style.top),
                data: n.data
            })),
            connections: this.connections.map(c => ({
                from: c.from,
                to: c.to
            })),
            timestamp: new Date().toISOString()
        };
        
        localStorage.setItem('lm_flow_pro_v2', JSON.stringify(payload));
        this.showNotification('Fluxo salvo no Cloud Local ‚úÖ', 'success');
    }

    exportFlow() {
        const payload = this.saveFlow();
        const dataStr = JSON.stringify(payload, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `lm-flow-${Date.now()}.json`;
        link.click();
    }

    loadFromStorage() {
        const raw = localStorage.getItem('lm_flow_pro_v2');
        if (!raw) return;
        
        try {
            const data = JSON.parse(raw);
            this.currentId = Math.max(...data.nodes.map(n => n.id), 0);
            this.loadState(data);
        } catch (e) {
            console.error('Erro ao carregar fluxo:', e);
        }
    }

    clearCanvas(confirmClear = true) {
        if (confirmClear && !confirm("Deseja apagar TODO o fluxo? Esta a√ß√£o n√£o pode ser desfeita.")) {
            return;
        }
        
        localStorage.removeItem('lm_flow_pro_v2');
        this.nodes.forEach(node => node.element.remove());
        this.connections.forEach(conn => conn.path.remove());
        this.nodes = [];
        this.connections = [];
        this.currentId = 0;
        this.closeEditor();
        this.undoStack = [];
        this.redoStack = [];
    }

    showNotification(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 90px;
            right: 20px;
            padding: 16px 24px;
            background: ${type === 'success' ? '#10B981' : '#3B82F6'};
            color: white;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            font-weight: 500;
        `;
        toast.textContent = message;
        document.body.appendChild(toast);



        
        setTimeout(() => toast.style.transform = 'translateX(0)', 100);
        setTimeout(() => {
            toast.style.transform = 'translateX(400px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
}

const builder = new FlowBuilder();
</script>
</body>
</html>


